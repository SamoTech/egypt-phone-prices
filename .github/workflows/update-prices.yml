name: Update Prices

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  scrape-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver
          pip install --upgrade pip
          pip install requests beautifulsoup4 selenium webdriver-manager

      - name: Run scraper
        run: python scraper.py

      - name: Create directories
        run: |
          mkdir -p docs
          mkdir -p data/history

      - name: Copy data
        run: cp data/phones_data.json docs/phones_data.json

      - name: Generate history and charts
        run: |
          python << 'EOF'
          import json
          import glob
          from datetime import datetime
          import os
          
          timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
          
          with open('data/phones_data.json', 'r', encoding='utf-8') as f:
              current_data = json.load(f)
          
          history_file = f'data/history/prices_{timestamp}.json'
          with open(history_file, 'w', encoding='utf-8') as f:
              json.dump(current_data, f, ensure_ascii=False, indent=2)
          
          print(f"✓ Saved to {history_file}")
          
          history = []
          for file in sorted(glob.glob('data/history/prices_*.json')):
              try:
                  with open(file, 'r', encoding='utf-8') as f:
                      data = json.load(f)
                      file_time = file.split('/')[-1].replace('prices_', '').replace('.json', '')
                      history.append({'timestamp': file_time, 'phones': data})
              except:
                  pass
          
          history = history[-720:]
          
          with open('docs/price_history.json', 'w', encoding='utf-8') as f:
              json.dump(history, f, ensure_ascii=False, indent=2)
          
          print(f"✓ History: {len(history)} entries")
          
          chart_data = {}
          for entry in history:
              for phone in entry.get('phones', []):
                  name = phone.get('name', 'Unknown')
                  if name not in chart_data:
                      chart_data[name] = {'timestamps': [], 'prices': []}
                  chart_data[name]['timestamps'].append(entry['timestamp'])
                  chart_data[name]['prices'].append(phone.get('price', 0))
          
          with open('docs/chart_data.json', 'w', encoding='utf-8') as f:
              json.dump(chart_data, f, ensure_ascii=False, indent=2)
          
          print(f"✓ Chart data for {len(chart_data)} phones")
          EOF

      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update prices - $(date)" && git push)

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
